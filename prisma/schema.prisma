generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Alert {
  id                String       @id
  practiceId        String
  alertType         AlertType
  relatedDocumentId String?
  relatedTaskId     String?
  recipientId       String
  channel           AlertChannel @default(EMAIL)
  message           String
  scheduledFor      DateTime
  sentAt            DateTime?
  status            AlertStatus  @default(PENDING)
  errorMessage      String?
  externalId        String?
  createdAt         DateTime     @default(now())
  Practice          Practice     @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  User              User         @relation(fields: [recipientId], references: [id])
  Document          Document?    @relation(fields: [relatedDocumentId], references: [id], onDelete: Cascade)
  Task              Task?        @relation(fields: [relatedTaskId], references: [id], onDelete: Cascade)

  @@index([alertType])
  @@index([practiceId])
  @@index([recipientId])
  @@index([scheduledFor])
  @@index([status])
}

model AuditLog {
  id         String      @id
  practiceId String
  userId     String
  action     AuditAction
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())
  Practice   Practice    @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  User       User        @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([entityType])
  @@index([practiceId])
  @@index([userId])
}

model Document {
  id                               String            @id
  practiceId                       String
  documentTypeId                   String
  title                            String
  fileUrl                          String
  fileName                         String
  fileSize                         Int
  mimeType                         String?
  uploadedById                     String
  approvedById                     String?
  approvedAt                       DateTime?
  effectiveDate                    DateTime?
  expiryDate                       DateTime?
  reviewDate                       DateTime?
  status                           DocumentStatus    @default(PENDING_APPROVAL)
  version                          Int               @default(1)
  notes                            String?
  createdAt                        DateTime          @default(now())
  updatedAt                        DateTime
  Alert                            Alert[]
  User_Document_approvedByIdToUser User?             @relation("Document_approvedByIdToUser", fields: [approvedById], references: [id])
  DocumentType                     DocumentType      @relation(fields: [documentTypeId], references: [id])
  Practice                         Practice          @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  User_Document_uploadedByIdToUser User              @relation("Document_uploadedByIdToUser", fields: [uploadedById], references: [id])
  DocumentVersion                  DocumentVersion[]

  @@index([documentTypeId])
  @@index([expiryDate])
  @@index([practiceId])
  @@index([status])
  @@index([uploadedById])
  @@index([practiceId, status]) // Composite for filtered queries
}

model DocumentCategory {
  id           String         @id
  name         String         @unique
  description  String?
  displayOrder Int            @default(0)
  icon         String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  DocumentType DocumentType[]

  @@index([displayOrder])
}

model DocumentType {
  id                  String           @id
  categoryId          String
  name                String
  description         String?
  isRequired          Boolean          @default(true)
  defaultReviewMonths Int?
  requiresExpiry      Boolean          @default(false)
  ohscMeasureNumber   String?
  guidanceNotes       String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime
  Document            Document[]
  DocumentCategory    DocumentCategory @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, name])
  @@index([isRequired])
}

model DocumentVersion {
  id            String   @id
  documentId    String
  versionNumber Int
  fileUrl       String
  fileName      String
  fileSize      Int
  uploadedById  String
  changeNotes   String?
  createdAt     DateTime @default(now())
  Document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

model Employee {
  id                       String                     @id
  practiceId               String
  userId                   String?                    @unique
  fullName                 String
  idNumber                 String?
  position                 String
  department               String?
  hireDate                 DateTime?
  hpcsaNumber              String?
  hpcsaExpiry              DateTime?
  sancNumber               String?
  sancExpiry               DateTime?
  blsExpiry                DateTime?
  isActive                 Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  address                  String?
  annualLeaveBalance       Float                      @default(15)
  dateOfBirth              DateTime?
  email                    String?
  employeeNumber           String?
  employmentType           EmploymentType             @default(PERMANENT)
  familyLeaveBalance       Float                      @default(3)
  jobDescriptionSigned     Boolean                    @default(false)
  jobDescriptionSignedAt   DateTime?
  phone                    String?
  sapcExpiry               DateTime?
  sapcNumber               String?
  sickLeaveBalance         Float                      @default(30)
  terminationDate          DateTime?
  // Compensation fields
  grossSalary              Float?
  payFrequency             PayFrequency?
  payDay                   Int?                       // Day of month (1-31) or day of week (1-7) depending on frequency
  bankName                 String?
  bankAccountNumber        String?
  bankBranchCode           String?
  uifExempt                Boolean                    @default(false)
  uifExemptReason          UifExemptReason?
  // Locum-specific fields
  isLocum                  Boolean                    @default(false)
  locumType                LocumType?
  locumAgency              String?                    // Agency they work through
  locumDailyRate           Float?                     // Daily rate for locums
  locumHourlyRate          Float?                     // Hourly rate for locums
  indemnityInsuranceNumber String?                    // Professional indemnity insurance
  indemnityInsuranceExpiry DateTime?
  locumContractUrl         String?                    // Stored contract document
  locumNotes               String?                    // Additional notes about the locum
  // PAYE tax configuration (added for tax compliance)
  taxNumber                String?                    // SARS tax number
  medicalAidDependents     Int                        @default(0) // For medical tax credits
  retirementContribution   Float?                     // Monthly retirement contribution
  payeOverride             Float?                     // Manual PAYE override (if set, skip auto-calculation)

  Practice                 Practice                   @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  EmployeeDocument         EmployeeDocument[]
  EmployeeTraining         EmployeeTraining[]
  KpiReview                KpiReview[]
  LeaveRequest             LeaveRequest[]
  ProfessionalRegistration ProfessionalRegistration[]
  Warning                  Warning[]
  EmployeeDeduction        EmployeeDeduction[]
  PayrollEntry             PayrollEntry[]
  TeamInvitation           TeamInvitation?
  PayrollAuditLog          PayrollAuditLog[]
  EmployeeYTD              EmployeeYTD[]
  EmployeeFringeBenefit    EmployeeFringeBenefit[]

  @@index([employeeNumber])
  @@index([isActive])
  @@index([practiceId])
}

model KpiReview {
  id          String          @id @default(cuid())
  employeeId  String
  quarter     Int             // 1, 2, 3, or 4
  year        Int
  status      KpiReviewStatus @default(DRAFT)
  reviewDate  DateTime?       // When the review was completed
  reviewedById String?        // Who conducted the review
  notes       String?         // Overall notes for the quarter
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  Employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  goals       KpiGoal[]

  @@unique([employeeId, quarter, year])
  @@index([employeeId])
  @@index([quarter, year])
  @@index([status])
}

model KpiGoal {
  id          String    @id @default(cuid())
  reviewId    String
  title       String
  description String?
  isMet       Boolean?  // null = pending, true = met, false = not met
  notes       String?   // Notes about whether goal was met
  markedAt    DateTime? // When the goal was marked as met/not met
  markedById  String?   // Who marked it
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  review      KpiReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

model EmployeeDocument {
  id           String    @id
  employeeId   String
  documentType String
  title        String
  fileUrl      String
  expiryDate   DateTime?
  uploadedById String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  fileName     String?
  fileSize     Int?
  isSigned     Boolean   @default(false)
  notes        String?
  signedAt     DateTime?
  Employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([documentType])
  @@index([employeeId])
  @@index([expiryDate])
}

// Practice-defined training module (CPD requirement)
model TrainingModule {
  id              String                       @id @default(cuid())
  practiceId      String
  name            String                       // e.g., "BLS Certification", "POPIA Compliance"
  description     String?
  provider        String?                      // e.g., "Heart Foundation", "Internal"
  cpdPoints       Int?                         // CPD points for this training
  validityMonths  Int?                         // How long certification is valid (null = no expiry)
  isRequired      Boolean                      @default(true) // Required vs optional training
  isActive        Boolean                      @default(true)
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt
  Practice        Practice                     @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  PositionRequirements PositionTrainingRequirement[]
  EmployeeTrainings    EmployeeTraining[]

  @@unique([practiceId, name])
  @@index([practiceId])
  @@index([isActive])
}

// Which positions require which training modules
model PositionTrainingRequirement {
  id                String         @id @default(cuid())
  practiceId        String
  position          String         // e.g., "Doctor", "Nurse", "Receptionist"
  trainingModuleId  String
  isRequired        Boolean        @default(true) // Required for this position specifically
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  TrainingModule    TrainingModule @relation(fields: [trainingModuleId], references: [id], onDelete: Cascade)

  @@unique([practiceId, position, trainingModuleId])
  @@index([practiceId, position])
  @@index([trainingModuleId])
}

// Employee training record - enhanced with pass/fail and module link
model EmployeeTraining {
  id                String          @id @default(cuid())
  employeeId        String
  trainingModuleId  String?         // Link to practice-defined module (null for ad-hoc trainings)
  trainingName      String          // Name of the training (copied from module or manual entry)
  provider          String?
  completedDate     DateTime
  expiryDate        DateTime?
  status            TrainingStatus  @default(COMPLETED) // Pass/Fail tracking
  score             Float?          // Optional score/percentage
  cpdPoints         Int?            // CPD points earned
  certificateUrl    String?
  certificateNumber String?
  notes             String?
  year              Int             // Year for CPD tracking (derived from completedDate)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  Employee          Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  TrainingModule    TrainingModule? @relation(fields: [trainingModuleId], references: [id])

  @@index([employeeId])
  @@index([expiryDate])
  @@index([trainingName])
  @@index([trainingModuleId])
  @@index([employeeId, year]) // For yearly CPD summary
  @@index([status])
}

model LeaveRequest {
  id               String      @id
  employeeId       String
  leaveType        LeaveType
  startDate        DateTime
  endDate          DateTime
  totalDays        Float
  reason           String?
  status           LeaveStatus @default(PENDING)
  sickNoteUrl      String?
  sickNoteUploaded Boolean     @default(false)
  approvedById     String?
  approvedAt       DateTime?
  declineReason    String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  Employee         Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([leaveType])
  @@index([startDate])
  @@index([status])
  @@index([approvedById])
}

model Practice {
  id                   String             @id
  name                 String
  practiceNumber       String?            // Practice registration/license number
  address              String?
  phone                String?
  email                String
  subscriptionTier     SubscriptionTier   @default(ESSENTIALS)
  subscriptionStatus   SubscriptionStatus @default(TRIAL)
  trialEndsAt          DateTime?
  onboardingCompleted  Boolean            @default(false)
  practiceSize         String?            // "solo", "small", "medium", "large"
  // Soft delete fields
  deletedAt            DateTime?          // When the account was marked for deletion
  scheduledDeletionAt  DateTime?          // When permanent deletion will occur (30 days after deletedAt)
  deletionReason       String?            // Optional reason for deletion
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  Alert                Alert[]
  AuditLog             AuditLog[]
  Document             Document[]
  Employee             Employee[]
  Locum                Locum[]
  Task                 Task[]
  TaskTemplate         TaskTemplate[]
  User                 User[]
  PayrollRun           PayrollRun[]
  PracticeDocument     PracticeDocument[]
  TeamInvitation       TeamInvitation[]
  TrainingModule       TrainingModule[]
  Complaint            Complaint[]
  AdverseEvent         AdverseEvent[]

  @@index([email])
  @@index([subscriptionStatus])
  @@index([scheduledDeletionAt])
}

model PracticeDocument {
  id          String   @id @default(cuid())
  practiceId  String
  name        String   // User-provided name/description
  fileName    String   // Original file name
  fileType    String   // MIME type
  fileSize    Int      // Size in bytes
  fileUrl     String   // Storage URL or path
  uploadedBy  String   // User ID who uploaded
  uploadedAt  DateTime @default(now())
  Practice    Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [uploadedBy], references: [id])

  @@index([practiceId])
}

model ProfessionalRegistration {
  id                 String           @id
  employeeId         String
  professionalBody   ProfessionalBody
  registrationNumber String
  expiryDate         DateTime?
  verifiedAt         DateTime?
  certificateUrl     String?
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  Employee           Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([expiryDate])
  @@index([professionalBody])
}

model Task {
  id                            String        @id
  practiceId                    String
  templateId                    String?
  title                         String
  description                   String?
  assignedToId                  String?
  dueDate                       DateTime
  dueTime                       String?
  completedAt                   DateTime?
  completedById                 String?
  evidenceUrl                   String?
  evidenceNotes                 String?
  verifiedById                  String?
  verifiedAt                    DateTime?
  status                        TaskStatus    @default(PENDING)
  escalatedAt                   DateTime?
  escalatedToId                 String?
  createdAt                     DateTime      @default(now())
  updatedAt                     DateTime
  Alert                         Alert[]
  User_Task_assignedToIdToUser  User?         @relation("Task_assignedToIdToUser", fields: [assignedToId], references: [id])
  User_Task_completedByIdToUser User?         @relation("Task_completedByIdToUser", fields: [completedById], references: [id])
  User_Task_escalatedToIdToUser User?         @relation("Task_escalatedToIdToUser", fields: [escalatedToId], references: [id])
  Practice                      Practice      @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  TaskTemplate                  TaskTemplate? @relation(fields: [templateId], references: [id])
  User_Task_verifiedByIdToUser  User?         @relation("Task_verifiedByIdToUser", fields: [verifiedById], references: [id])

  @@index([assignedToId])
  @@index([dueDate])
  @@index([practiceId])
  @@index([status])
  @@index([templateId])
  @@index([practiceId, status, dueDate]) // Composite for dashboard queries
}

model TaskTemplate {
  id                       String        @id
  practiceId               String
  name                     String
  description              String?
  frequency                TaskFrequency @default(DAILY)
  frequencyConfig          Json?
  requiresEvidence         Boolean       @default(false)
  escalationThresholdHours Int?
  assignedRole             UserRole?
  category                 String?
  isActive                 Boolean       @default(true)
  createdById              String
  createdAt                DateTime      @default(now())
  updatedAt                DateTime
  Task                     Task[]
  User                     User          @relation(fields: [createdById], references: [id])
  Practice                 Practice      @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([frequency])
  @@index([isActive])
  @@index([practiceId])
}

model User {
  id                                   String         @id
  clerkId                              String?        @unique
  practiceId                           String?
  email                                String         @unique
  name                                 String
  phone                                String?
  role                                 UserRole       @default(STAFF)
  isActive                             Boolean        @default(true)
  twoFactorEnabled                     Boolean        @default(false)
  twoFactorSecret                      String?
  twoFactorBackupCodes                 String?        // JSON array of backup codes
  // Notification preferences (stored as JSON for flexibility)
  notifyExpiry90Days                   Boolean        @default(true)
  notifyExpiry60Days                   Boolean        @default(true)
  notifyExpiry30Days                   Boolean        @default(true)
  notifyExpiryCritical                 Boolean        @default(true)  // 14, 7, 0 days
  notifyTaskAssignment                 Boolean        @default(true)
  notifyTaskOverdue                    Boolean        @default(true)
  notifyWeeklyDigest                   Boolean        @default(false)
  createdAt                            DateTime       @default(now())
  updatedAt                            DateTime
  Alert                                Alert[]
  AuditLog                             AuditLog[]
  Document_Document_approvedByIdToUser Document[]     @relation("Document_approvedByIdToUser")
  Document_Document_uploadedByIdToUser Document[]     @relation("Document_uploadedByIdToUser")
  Task_Task_assignedToIdToUser         Task[]         @relation("Task_assignedToIdToUser")
  Task_Task_completedByIdToUser        Task[]         @relation("Task_completedByIdToUser")
  Task_Task_escalatedToIdToUser        Task[]         @relation("Task_escalatedToIdToUser")
  Task_Task_verifiedByIdToUser         Task[]         @relation("Task_verifiedByIdToUser")
  TaskTemplate                         TaskTemplate[]
  Practice                             Practice?      @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  PracticeDocument                     PracticeDocument[]
  TeamInvitation                       TeamInvitation[]
  Locum                                Locum?

  @@index([email])
  @@index([practiceId])
  @@index([role])
}

model Warning {
  id              String          @id
  employeeId      String
  warningType     WarningType
  category        WarningCategory
  incidentDate    DateTime
  description     String
  issuedById      String
  issuedAt        DateTime        @default(now())
  expiresAt       DateTime
  acknowledged    Boolean         @default(false)
  acknowledgedAt  DateTime?
  employeeComment String?
  documentUrl     String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  Employee        Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([warningType])
}

enum AlertChannel {
  EMAIL
  WHATSAPP
  IN_APP
}

enum AlertStatus {
  PENDING
  SENT
  FAILED
}

enum AlertType {
  DOCUMENT_EXPIRY
  TASK_OVERDUE
  TASK_REMINDER
  ESCALATION
  TASK_ASSIGNED
  LEAVE_REQUEST
  LEAVE_APPROVED
  LEAVE_DECLINED
  WARNING_ISSUED
  TRAINING_EXPIRY
  REGISTRATION_EXPIRY
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  EXPORT
  UPLOAD
  DOWNLOAD
  APPROVE
  COMPLETE
}

enum DocumentStatus {
  CURRENT
  EXPIRING_SOON
  EXPIRED
  NEEDS_REVIEW
  PENDING_APPROVAL
}

enum EmploymentType {
  PERMANENT
  CONTRACT
  PART_TIME
  TEMPORARY
  LOCUM
}

enum KpiReviewStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

enum LeaveStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

enum LeaveType {
  ANNUAL
  SICK
  FAMILY_RESPONSIBILITY
  MATERNITY
  UNPAID
  STUDY
}

enum ProfessionalBody {
  HPCSA
  SANC
  SAPC
  AHPCSA
  OTHER
}

enum LocumType {
  DOCTOR
  NURSE
  MEDICAL_ASSISTANT
  OTHER
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  PAST_DUE
}

enum SubscriptionTier {
  ESSENTIALS
  PROFESSIONAL
  ENTERPRISE
}

enum TaskFrequency {
  MULTIPLE_DAILY
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  BIANNUALLY
  ANNUALLY
  EVERY_TWO_YEARS
  EVERY_FIVE_YEARS
  CUSTOM
}

enum TaskStatus {
  PENDING
  COMPLETED
  OVERDUE
  VERIFIED
}

enum UserRole {
  SUPER_ADMIN
  PRACTICE_OWNER
  ADMIN
  STAFF
  VIEWER
  LOCUM
}

enum WarningCategory {
  LATE_ARRIVAL
  ABSENTEEISM
  MISCONDUCT
  NEGLIGENCE
  INSUBORDINATION
  POLICY_VIOLATION
  PERFORMANCE
  OTHER
}

enum WarningType {
  VERBAL
  WRITTEN
  FINAL_WRITTEN
}

enum PayFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum UifExemptReason {
  WORKS_LESS_THAN_24_HOURS
  INDEPENDENT_CONTRACTOR
  LEARNER_UNDER_AGREEMENT
  PUBLIC_SERVANT
  FOREIGN_GOVERNMENT_EMPLOYEE
  OTHER
}

enum DeductionType {
  PAYE
  UIF
  PENSION
  MEDICAL_AID
  CUSTOM
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  PAID
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// Employee deductions - what deductions apply to each employee
model EmployeeDeduction {
  id              String        @id @default(cuid())
  employeeId      String
  deductionType   DeductionType
  name            String?       // For custom deductions
  amount          Float?        // Fixed amount
  percentage      Float?        // Percentage of gross (for pension)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  Employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([deductionType])
}

// Monthly payroll run for the practice
model PayrollRun {
  id                  String         @id @default(cuid())
  practiceId          String
  month               Int            // 1-12
  year                Int
  status              PayrollStatus  @default(DRAFT)
  totalGross          Float          @default(0)
  totalDeductions     Float          @default(0)
  totalNet            Float          @default(0)
  totalEmployerUif    Float          @default(0)
  totalEmployerSdl    Float          @default(0)
  processedAt         DateTime?
  processedById       String?
  paidAt              DateTime?
  sarsSubmitted       Boolean        @default(false)
  sarsSubmittedAt     DateTime?
  notes               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  Practice            Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  PayrollEntry        PayrollEntry[]
  PayrollAuditLog     PayrollAuditLog[]

  @@unique([practiceId, month, year])
  @@index([practiceId])
  @@index([month, year])
  @@index([status])
}

// Individual employee entry in a payroll run
model PayrollEntry {
  id                String             @id @default(cuid())
  payrollRunId      String
  employeeId        String
  grossSalary       Float
  // Deduction amounts
  payeAmount        Float              @default(0)
  uifAmount         Float              @default(0)
  pensionAmount     Float              @default(0)
  medicalAidAmount  Float              @default(0)
  otherDeductions   Float              @default(0)
  totalDeductions   Float              @default(0)
  netSalary         Float
  // Employer contributions
  employerUif       Float              @default(0)
  employerSdl       Float              @default(0)
  // Irregular payments (Phase 5)
  paymentType       PaymentType        @default(REGULAR)
  bonusAmount       Float?             // Bonus/commission amount
  annualisationMethod String?          // 'standard', 'average_over_period', 'lump_sum_table'
  // Fringe benefits
  fringeBenefitsTotal Float            @default(0)
  // Payment details
  paymentDate       DateTime?
  paymentReference  String?
  // Payslip
  payslipUrl        String?
  payslipGeneratedAt DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  PayrollRun        PayrollRun         @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  Employee          Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  PayrollDeduction  PayrollDeduction[]
  PayrollAddition   PayrollAddition[]

  @@unique([payrollRunId, employeeId])
  @@index([payrollRunId])
  @@index([employeeId])
  @@index([paymentType])
}

// Detailed deductions for each payroll entry (for itemized payslips)
model PayrollDeduction {
  id             String        @id @default(cuid())
  payrollEntryId String
  deductionType  DeductionType
  name           String        // Display name
  amount         Float
  createdAt      DateTime      @default(now())
  PayrollEntry   PayrollEntry  @relation(fields: [payrollEntryId], references: [id], onDelete: Cascade)

  @@index([payrollEntryId])
}

// Irregular payments/additions for a payroll entry (bonus, overtime, commission, etc.)
model PayrollAddition {
  id             String      @id @default(cuid())
  payrollEntryId String
  paymentType    PaymentType
  name           String      // Display name (e.g., "December Bonus", "Week 1 Overtime")
  amount         Float
  createdAt      DateTime    @default(now())
  PayrollEntry   PayrollEntry @relation(fields: [payrollEntryId], references: [id], onDelete: Cascade)

  @@index([payrollEntryId])
}

// Separate Locum model - independent from employees
model Locum {
  id                       String           @id @default(cuid())
  practiceId               String
  userId                   String?          @unique // Links to User for login/auth
  fullName                 String
  email                    String?
  phone                    String?
  idNumber                 String?
  // Professional registration
  hpcsaNumber              String?
  hpcsaExpiry              DateTime?
  // Source and payment
  sourceType               LocumSourceType  @default(DIRECT)
  agencyName               String?          // If agency-sourced
  hourlyRate               Float
  // Insurance
  indemnityInsuranceNumber String?
  indemnityInsuranceExpiry DateTime?
  // Status
  isActive                 Boolean          @default(true)
  notes                    String?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  // Relations
  Practice                 Practice         @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  User                     User?            @relation(fields: [userId], references: [id])
  LocumTimesheet           LocumTimesheet[]
  LocumDocument            LocumDocument[]

  @@index([practiceId])
  @@index([isActive])
  @@index([sourceType])
}

// Locum documents (HPCSA certificate, indemnity insurance, etc.)
model LocumDocument {
  id           String   @id @default(cuid())
  locumId      String
  documentType String   // e.g., "HPCSA Certificate", "Indemnity Insurance", "Contract"
  title        String
  fileUrl      String
  fileName     String?
  fileSize     Int?
  expiryDate   DateTime?
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  Locum        Locum    @relation(fields: [locumId], references: [id], onDelete: Cascade)

  @@index([locumId])
  @@index([documentType])
  @@index([expiryDate])
}

// Timesheet for clock in/out tracking
model LocumTimesheet {
  id            String              @id @default(cuid())
  locumId       String
  practiceId    String
  date          DateTime            @db.Date
  clockIn       DateTime?           // When they clocked in
  clockOut      DateTime?           // When they clocked out
  breakMinutes  Int                 @default(0) // Total break time in minutes
  hoursWorked   Float?              // Calculated: (clockOut - clockIn - breakMinutes) / 60
  hourlyRate    Float               // Rate at time of shift (copied from Locum)
  totalPayable  Float?              // Calculated: hoursWorked * hourlyRate
  status        TimesheetStatus     @default(CLOCKED_IN)
  notes         String?             // Locum can add notes
  // Approval
  approvedById  String?
  approvedAt    DateTime?
  rejectedById  String?
  rejectedAt    DateTime?
  rejectionNote String?
  // Payment tracking
  paymentStatus PaymentStatus       @default(UNPAID)
  paidAt        DateTime?
  paymentRef    String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  Locum         Locum               @relation(fields: [locumId], references: [id], onDelete: Cascade)

  @@unique([locumId, date])
  @@index([locumId])
  @@index([practiceId])
  @@index([date])
  @@index([status])
  @@index([paymentStatus])
  @@index([practiceId, status, paymentStatus]) // Composite for payment queries
}

enum LocumSourceType {
  DIRECT    // Hired directly by practice
  AGENCY    // Through an agency
}

enum TimesheetStatus {
  CLOCKED_IN        // Currently working
  CLOCKED_OUT       // Finished, pending approval
  APPROVED          // Manager approved
  REJECTED          // Manager rejected (needs correction)
}

enum PaymentStatus {
  UNPAID
  PAID
}

enum TrainingStatus {
  COMPLETED   // Passed/completed successfully
  FAILED      // Did not pass
  IN_PROGRESS // Currently undertaking
  EXPIRED     // Previously completed but now expired
}

// Team invitation for inviting employees to create user accounts
model TeamInvitation {
  id          String           @id @default(cuid())
  practiceId  String
  employeeId  String           @unique
  email       String
  role        UserRole
  token       String           @unique
  expiresAt   DateTime
  invitedById String
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  acceptedAt  DateTime?

  Practice    Practice         @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  Employee    Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  InvitedBy   User             @relation(fields: [invitedById], references: [id])

  @@index([practiceId])
  @@index([status])
  @@index([token])
}

// =============================================================================
// ADMIN PANEL MODELS
// =============================================================================

// System-wide configuration and feature flags
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   // JSON stringified value
  description String?
  category    String   @default("general") // general, features, limits, email, etc.
  isSecret    Boolean  @default(false) // Don't expose in API responses
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// Feature flags for granular feature control
model FeatureFlag {
  id            String   @id @default(cuid())
  name          String   @unique // e.g., "ai_assistant", "payroll", "locums"
  description   String?
  isEnabled     Boolean  @default(true)
  enabledForAll Boolean  @default(true) // If false, check FeatureFlagOverride
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  Overrides FeatureFlagOverride[]
}

// Per-practice feature flag overrides
model FeatureFlagOverride {
  id            String      @id @default(cuid())
  featureFlagId String
  practiceId    String
  isEnabled     Boolean
  reason        String?     // Why this override exists
  expiresAt     DateTime?   // Optional expiry for temporary access
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  FeatureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, practiceId])
  @@index([practiceId])
}

// Admin activity log (separate from practice AuditLog)
model AdminAuditLog {
  id          String          @id @default(cuid())
  adminId     String          // User ID of admin who performed action
  action      AdminAction
  entityType  String          // Practice, User, SystemConfig, etc.
  entityId    String?
  practiceId  String?         // If action relates to a specific practice
  details     Json?           // Additional action details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime        @default(now())

  @@index([adminId])
  @@index([action])
  @@index([entityType])
  @@index([practiceId])
  @@index([createdAt])
}

// System announcements to all users
model SystemAnnouncement {
  id          String              @id @default(cuid())
  title       String
  message     String
  type        AnnouncementType    @default(INFO)
  isActive    Boolean             @default(true)
  showFrom    DateTime            @default(now())
  showUntil   DateTime?
  targetTiers SubscriptionTier[]  // Empty = all tiers
  createdById String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([isActive])
  @@index([showFrom, showUntil])
}

// Email templates for system emails
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "welcome", "password_reset", "expiry_reminder"
  subject     String
  htmlBody    String
  textBody    String?
  variables   String[] // List of available template variables
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Email log for tracking sent emails
model EmailLog {
  id          String       @id @default(cuid())
  practiceId  String?
  recipientId String?      // User ID if applicable
  templateId  String?
  toEmail     String
  subject     String
  status      EmailStatus  @default(PENDING)
  sentAt      DateTime?
  errorMessage String?
  externalId  String?      // ID from email provider (Resend, SendGrid, etc.)
  createdAt   DateTime     @default(now())

  @@index([practiceId])
  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
}

// API usage tracking for rate limiting and analytics
model ApiUsageLog {
  id          String   @id @default(cuid())
  practiceId  String?
  userId      String?
  endpoint    String
  method      String
  statusCode  Int
  responseMs  Int      // Response time in milliseconds
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([practiceId])
  @@index([userId])
  @@index([endpoint])
  @@index([createdAt])
}

// Error tracking for system health monitoring
model ErrorLog {
  id          String       @id @default(cuid())
  practiceId  String?
  userId      String?
  errorType   String       // e.g., "DATABASE", "API", "AUTH", "PAYMENT"
  errorCode   String?
  message     String
  stack       String?
  context     Json?        // Additional context (request body, etc.)
  resolved    Boolean      @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime     @default(now())

  @@index([practiceId])
  @@index([errorType])
  @@index([resolved])
  @@index([createdAt])
}

// Support tickets
model SupportTicket {
  id           String              @id @default(cuid())
  practiceId   String?
  userId       String?
  userEmail    String
  subject      String
  description  String
  category     TicketCategory      @default(OTHER)
  priority     TicketPriority      @default(MEDIUM)
  status       TicketStatus        @default(OPEN)
  assignedToId String?             // Admin user ID
  resolvedAt   DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  Messages     SupportTicketMessage[]

  @@index([practiceId])
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
}

// Support ticket messages/replies
model SupportTicketMessage {
  id          String        @id @default(cuid())
  ticketId    String
  senderId    String?       // User or Admin ID
  senderEmail String
  senderName  String
  isFromAdmin Boolean       @default(false)
  message     String
  attachments String[]      // URLs to attachments
  createdAt   DateTime      @default(now())

  Ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// Admin panel enums
enum AdminAction {
  VIEW_PRACTICE
  VIEW_USER
  IMPERSONATE_USER
  UPDATE_SUBSCRIPTION
  SUSPEND_PRACTICE
  ACTIVATE_PRACTICE
  SUSPEND_USER
  ACTIVATE_USER
  RESET_PASSWORD
  RESET_2FA
  UPDATE_CONFIG
  UPDATE_FEATURE_FLAG
  CREATE_ANNOUNCEMENT
  DELETE_ANNOUNCEMENT
  RESPOND_TICKET
  CLOSE_TICKET
  EXPORT_DATA
}

enum AnnouncementType {
  INFO
  WARNING
  SUCCESS
  MAINTENANCE
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum TicketCategory {
  BILLING
  TECHNICAL
  FEATURE_REQUEST
  BUG_REPORT
  ACCOUNT
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_RESPONSE
  RESOLVED
  CLOSED
}

// =============================================================================
// PAYROLL ENHANCEMENTS - TAX COMPLIANCE & REPORTING
// =============================================================================

// SARS tax brackets for PAYE calculation
model TaxBracket {
  id        String   @id @default(cuid())
  taxYear   String   // "2024/2025"
  minIncome Decimal  @db.Decimal(12, 2)
  maxIncome Decimal? @db.Decimal(12, 2) // null = unlimited (top bracket)
  rate      Decimal  @db.Decimal(5, 4) // 0.18, 0.26, 0.31, 0.36, 0.39, 0.41, 0.45
  baseTax   Decimal  @db.Decimal(12, 2) // Fixed amount at start of bracket
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([taxYear, minIncome])
  @@index([taxYear])
}

// SARS tax rebates (age-based)
model TaxRebate {
  id           String     @id @default(cuid())
  taxYear      String     // "2024/2025"
  rebateType   RebateType
  amount       Decimal    @db.Decimal(10, 2)
  ageThreshold Int?       // 65 for secondary, 75 for tertiary
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([taxYear, rebateType])
  @@index([taxYear])
}

enum RebateType {
  PRIMARY   // All taxpayers
  SECONDARY // Age 65+
  TERTIARY  // Age 75+
}

// Medical tax credits
model MedicalTaxCredit {
  id              String   @id @default(cuid())
  taxYear         String   // "2024/2025"
  mainMember      Decimal  @db.Decimal(10, 2) // R364
  firstDependent  Decimal  @db.Decimal(10, 2) // R364
  otherDependents Decimal  @db.Decimal(10, 2) // R246 per additional
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([taxYear])
}

// Immutable audit trail for all payroll calculations
model PayrollAuditLog {
  id                   String     @id @default(cuid())
  payrollRunId         String
  employeeId           String
  calculationTimestamp DateTime   @default(now())

  // Calculation snapshot
  grossRemuneration    Decimal    @db.Decimal(12, 2)
  taxableIncome        Decimal    @db.Decimal(12, 2)
  payeCalculated       Decimal    @db.Decimal(12, 2)
  uifEmployee          Decimal    @db.Decimal(8, 2)
  uifEmployer          Decimal    @db.Decimal(8, 2)
  sdl                  Decimal    @db.Decimal(8, 2)

  // Detailed breakdown (JSON for flexibility)
  calculationBreakdown Json       // Step-by-step PAYE calculation
  appliedRebates       Json       // Which rebates were applied
  medicalCredits       Decimal    @db.Decimal(8, 2)
  fringeBenefits       Decimal    @db.Decimal(10, 2) @default(0)

  // Metadata
  taxYear              String
  createdBy            String
  createdAt            DateTime   @default(now())

  PayrollRun           PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  Employee             Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([payrollRunId])
  @@index([employeeId])
  @@index([taxYear])
  @@index([calculationTimestamp])
}

// Year-to-date tracking per employee per tax year
model EmployeeYTD {
  id                  String   @id @default(cuid())
  employeeId          String
  taxYear             String   // "2024/2025"

  // Cumulative totals
  ytdGross            Decimal  @db.Decimal(12, 2) @default(0)
  ytdTaxableIncome    Decimal  @db.Decimal(12, 2) @default(0)
  ytdPaye             Decimal  @db.Decimal(12, 2) @default(0)
  ytdUifEmployee      Decimal  @db.Decimal(12, 2) @default(0)
  ytdUifEmployer      Decimal  @db.Decimal(12, 2) @default(0)
  ytdSdl              Decimal  @db.Decimal(12, 2) @default(0)
  ytdRetirement       Decimal  @db.Decimal(12, 2) @default(0)
  ytdMedicalAid       Decimal  @db.Decimal(12, 2) @default(0)
  ytdMedicalCredits   Decimal  @db.Decimal(12, 2) @default(0)
  ytdFringeBenefits   Decimal  @db.Decimal(12, 2) @default(0)

  lastUpdated         DateTime @updatedAt
  createdAt           DateTime @default(now())

  Employee            Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, taxYear])
  @@index([employeeId])
  @@index([taxYear])
}

// Fringe benefits tracking per employee
model EmployeeFringeBenefit {
  id                  String      @id @default(cuid())
  employeeId          String
  benefitType         BenefitType
  monthlyTaxableValue Decimal     @db.Decimal(10, 2)
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  calculationMethod   Json?       // SARS calculation parameters
  description         String?     // E.g., "BMW 320i - Company Car"
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  Employee            Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([benefitType])
  @@index([effectiveFrom, effectiveTo])
}

enum BenefitType {
  COMPANY_CAR
  HOUSING_ALLOWANCE
  MEDICAL_AID_EMPLOYER_PORTION
  CELL_PHONE
  TRAVEL_ALLOWANCE
  FUEL_CARD
  MEAL_ALLOWANCE
  OTHER
}

// Payment types for irregular payments
enum PaymentType {
  REGULAR
  BONUS
  COMMISSION
  BACKPAY
  SEVERANCE
  THIRTEENTH_CHEQUE
  OVERTIME
  ALLOWANCE
}

// =============================================================================
// OHSC REGISTERS - COMPLAINTS & ADVERSE EVENTS
// =============================================================================

// Complaints Register - OHSC Non-Negotiable #5
model Complaint {
  id                  String            @id @default(cuid())
  practiceId          String
  referenceNumber     String            // Auto-generated: CMP-2025-001

  // Complaint Details
  dateReceived        DateTime
  complainantName     String?           // Optional - can be anonymous
  complainantContact  String?           // Phone or email

  // Classification
  category            ComplaintCategory
  severity            Severity          @default(MEDIUM)
  summary             String            // Brief description (required)
  details             String?           // Full details (optional)

  // Investigation
  investigatedBy      String?           // Staff member name
  investigationDate   DateTime?
  investigationNotes  String?
  rootCause           String?

  // Resolution
  status              ComplaintStatus   @default(RECEIVED)
  acknowledgedAt      DateTime?         // OHSC requires acknowledgement within 5 working days
  resolvedAt          DateTime?
  resolutionSummary   String?
  resolutionType      ResolutionType?

  // Evidence/Attachments
  attachments         String[]          // URLs to supporting documents

  // Audit
  createdAt           DateTime          @default(now())
  createdBy           String            // User ID who logged it
  updatedAt           DateTime          @updatedAt

  Practice            Practice          @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@unique([practiceId, referenceNumber])
  @@index([practiceId])
  @@index([status])
  @@index([dateReceived])
  @@index([category])
}

// Adverse Events Register - OHSC Non-Negotiable #10
model AdverseEvent {
  id                    String                @id @default(cuid())
  practiceId            String
  referenceNumber       String                // Auto-generated: AE-2025-001

  // Event Details
  eventDate             DateTime
  reportedDate          DateTime              @default(now())

  // Patient (anonymized)
  patientInitials       String?               // e.g., "JM"
  patientFileNumber     String?               // Internal reference only

  // Classification
  category              AdverseEventCategory
  severity              AdverseEventSeverity
  description           String                // What happened

  // Investigation
  investigatedBy        String?
  investigationDate     DateTime?
  findings              String?
  rootCause             String?

  // Corrective Action
  correctiveAction      String?
  actionImplementedDate DateTime?
  actionVerifiedBy      String?
  preventionPlan        String?

  // Outcome
  patientOutcome        PatientOutcome?
  reportedToAuthority   Boolean               @default(false)
  authorityReportDate   DateTime?

  // Status
  status                EventStatus           @default(REPORTED)

  // Attachments
  attachments           String[]              // URLs to supporting documents

  // Audit
  createdAt             DateTime              @default(now())
  createdBy             String
  updatedAt             DateTime              @updatedAt

  Practice              Practice              @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@unique([practiceId, referenceNumber])
  @@index([practiceId])
  @@index([eventDate])
  @@index([status])
  @@index([category])
  @@index([severity])
}

// Complaint enums
enum ComplaintCategory {
  SERVICE         // Quality of care
  STAFF           // Staff behavior
  BILLING         // Financial issues
  FACILITIES      // Premises, equipment
  WAITING_TIME    // Delays
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
}

enum ComplaintStatus {
  RECEIVED        // Just logged
  ACKNOWLEDGED    // User notified within 5 days
  INVESTIGATING   // Being looked into
  RESOLVED        // Action taken
  CLOSED          // Fully complete
}

enum ResolutionType {
  APOLOGY
  EXPLANATION
  REMEDIAL_ACTION
  POLICY_CHANGE
  TRAINING
  REFUND
  OTHER
}

// Adverse Event enums
enum AdverseEventCategory {
  MEDICATION_ERROR        // Wrong drug, dose, patient
  PROCEDURE_COMPLICATION  // Unexpected outcome from procedure
  DIAGNOSTIC_ERROR        // Missed or wrong diagnosis
  EQUIPMENT_FAILURE       // Medical device malfunction
  FALL                    // Patient fell
  INFECTION               // Healthcare-associated infection
  ALLERGIC_REACTION       // Drug reaction
  NEEDLE_STICK            // Staff injury
  OTHER
}

enum AdverseEventSeverity {
  NEAR_MISS   // Almost happened but caught in time
  MINOR       // No lasting harm
  MODERATE    // Required additional treatment
  SEVERE      // Permanent harm or death
}

enum PatientOutcome {
  NO_HARM
  MINOR_HARM
  MODERATE_HARM
  SEVERE_HARM
  DEATH
}

enum EventStatus {
  REPORTED      // Initial report
  INVESTIGATING // Being investigated
  ACTION_TAKEN  // Corrective action implemented
  CLOSED        // Fully resolved
}
